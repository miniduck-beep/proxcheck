#!/bin/bash

# Proxy Test API Server Launcher
# Usage: ./api_server [options]

cd "$(dirname "$0")"

# Default values
PORT=9090
DATA_DIR="/tmp/proxy-test-api"
VERBOSE=false

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--port)
            PORT="$2"
            shift 2
            ;;
        -d|--data-dir)
            DATA_DIR="$2"
            shift 2
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        -h|--help)
            echo "Proxy Test API Server"
            echo ""
            echo "Usage: $0 [options]"
            echo ""
            echo "Options:"
            echo "  -p, --port PORT      Port to run on (default: 9090)"
            echo "  -d, --data-dir DIR   Data directory (default: /tmp/proxy-test-api)"
            echo "  -v, --verbose        Enable verbose output"
            echo "  -h, --help           Show this help"
            echo ""
            echo "Examples:"
            echo "  $0 -p 8080"
            echo "  $0 --port 9090 --data-dir ./data"
            echo "  $0 --verbose"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use -h or --help for usage information"
            exit 1
            ;;
    esac
done

# Check if port is available
if lsof -Pi :$PORT -sTCP:LISTEN -t >/dev/null; then
    echo "âŒ Port $PORT is already in use"
    echo "ğŸ’¡ You can:"
    echo "   - Use a different port: ./api_server -p 8080"
    echo "   - Free the port: kill -9 \$(lsof -ti:$PORT)"
    echo "   - Check what's using it: lsof -i :$PORT"
    exit 1
fi

# Build the command
CMD="go run improved_api.go -port $PORT -data-dir \"$DATA_DIR\""

if [ "$VERBOSE" = true ]; then
    CMD="$CMD -verbose"
fi

echo "ğŸš€ Starting Proxy Test API Server"
echo "ğŸ“ Port: $PORT"
echo "ğŸ’¾ Data directory: $DATA_DIR"
echo "ğŸ”— Health check: http://localhost:$PORT/health"
echo ""
echo "Press Ctrl+C to stop the server"
echo ""

# Create data directory if it doesn't exist
mkdir -p "$DATA_DIR"

# Run the server
eval $CMD